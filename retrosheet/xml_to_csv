#!/usr/bin/env ruby
#
# Extract tabular data (CSV format) from XML generated by cwbox -X.
#
# Usage:
#
#   xml_to_csv <batters|pitchers> <xml_file>
#
#
# To load batter data from output into MySQL database:
#
#   LOAD DATA LOCAL INFILE '...' INTO TABLE batting_games FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n' IGNORE 0 LINES;
#
# Then convert Retrosheet player ids to BDB ids:
#   UPDATE batting_games bg INNER JOIN players p ON bg.player_id = p.retro_id SET bg.player_id = p.id;
#
#
# To load pitcher data into MySQL database
#   LOAD DATA LOCAL INFILE '...' INTO TABLE pitching_games FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n' IGNORE 0 LINES;
#
# Then convert Retrosheet player ids to BDB ids:
#   UPDATE pitching_games bg INNER JOIN players p ON bg.player_id = p.retro_id SET bg.player_id = p.id;
#

require 'rubygems'
require 'nokogiri'

module ArrayToHash
  def to_hash(a); Hash[*a.flatten]; end
end


@type = ARGV[0]
@file = ARGV[1]
if @file.nil?
  puts "Please specify 'batters' or 'pitchers' as well as a file name."
  exit
elsif !%w[batters pitchers].include?(@type)
  puts "Please specify 'batters' or 'pitchers' as stat type."
  exit
end


class BatterGame < Nokogiri::XML::SAX::Document
  include ArrayToHash
  def start_element(e, a)
    case e
    when 'boxscore'
      a = to_hash(a)
      @game_id = a['game_id']
      @game_date = a['date'].gsub('/', '-')
      @home_team = a['home']
    when 'players'
      a = to_hash(a)
      @team = a['team']
    when 'player'
      a = to_hash(a)
      @player_id = a['id']
    when 'batting'
      a = to_hash(a)
      puts [
        @player_id,
        @game_date[0...4],        # year
        "",                       # league
        @team,                    # team
        @game_date,               # game date
        @home_team,               # home team
        @game_id[-1..-1],         # game_number
        a['ab'].to_i > 0 ? 1 : 0, # 1=player batted, 0=did not bat
        a['ab'],
        a['r'],
        a['h'],
        a['d'],
        a['t'],
        a['hr'],
        a['bi'],
        a['sb'],
        a['cs'],
        a['bb'],
        a['so'],
        a['ibb'],
        a['hp'],
        a['sh'],
        a['sf'],
        a['gdp']
      ].map{ |i| i.to_s == i.to_i.to_s ? (i.to_i < 0 ? "" : i) : "\"#{i}\"" }.join(',')
    end
  end
end

class PitcherGame < Nokogiri::XML::SAX::Document
  include ArrayToHash
  def start_element(e, a)
    case e
    when 'boxscore'
      a = to_hash(a)
      @game_id = a['game_id']
      @game_date = a['date'].gsub('/', '-')
      @home_team = a['home']
    when 'pitching'
      a = to_hash(a)
      @team = a['team']
    when 'pitcher'
      a = to_hash(a)
      @player_id = a['id']
      puts [
        @player_id,
        @game_date[0...4],        # year
        "",                       # league
        @team,                    # team
        @game_date,               # game date
        @home_team,               # home team
        @game_id[-1..-1],         # game_number
        a['dec'] == 'W' ? 1 : 0, # w
        a['dec'] == 'L' ? 1 : 0, # l
        1, # g
        a['gs'],
        a['cg'],
        a['sho'],
        a['dec'] == 'S' ? 1 : 0, # sv
        a['outs'],
        a['h'],
        a['er'],
        a['hr'],
        a['bb'],
        a['so'],
        a['ibb'],
        a['wp'],
        a['hb'],
        a['bk'],
        a['bf'],
        a['gf'],
        a['r'],
      ].map{ |i| i.to_s == i.to_i.to_s ? (i.to_i < 0 ? "" : i) : "\"#{i}\"" }.join(',')
    end
  end
end

klass = @type == 'batters' ? BatterGame : PitcherGame
parser = Nokogiri::XML::SAX::Parser.new(klass.new)
parser.parse_file(File.join(ARGV[1]))
